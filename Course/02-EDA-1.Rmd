# Exloratory Data Analysis - I {#eda-1}


## Objectives
- Remember how to load and explore datasets in R
- Conduct basic descriptive data analysis 
- Undestand and visualize distribution of and relationship between variables

## R functions covered this week
- `load()`
- `read_excel()`
- `str()`
- `glimpse()`
- `table()`
- `summary()`
- `mutate()`
- `case_when()`
- `ggplot()`
- `corr ()`


## Why is EDA so important?

+ Every regression analysis is based on proper EDA; EDA often used for "hypothesis generation" (i.e. finding things that could be interesting to study). 
+ `EDA` helps understand the data and issues in the data. The better we understand the data, the better we can "fine-tune" our regression model later.
+ `EDA` helps prepping data for regression (i.e. "cleaning"; "pre-processing"). Small errors in the data can lead to completely wrong conclusions or even prevent 
the model from working altogether. 


## Importing data into R
The first step of any data analysis is getting data into R. To get started, we first need to follow some preparatory steps

1. In this course, we will use data on NBA players (Basketball). Usually, you need to first download the data and documentation and save them in a folder on your own computer. We have already done this, and provide the data for you here. 

2. Install R and Rstudio. If you don't already have R installed, here is a link to how it is done (hyperlink)

3. In the folder which you will use for this class, create a new R project. You will see that all files appear in the bottom right window in R studio. 

Now, Let's get started. 

## Import data into R

First, we need to install some packages.

```{r install_packages, warning=FALSE, message=FALSE}
library("tidyverse")
library("readxl")
```


Now, let's import the data.You can see in the folder that we have 2 csv files. 
We can use `read_delim()` or `read_csv` function. Note that you need other function for Stata datasets (`read_data` from the haven package). To load Rdata files, you use the `load()` function.

Make sure you name the correct sub-directory in case you saved the data a sub-folder of your project folder (which I have done).


```{r import_csv, warning=FALSE}
# import data 
nba_salaries <- read_csv("../datasets/nba/salaries_1985to2018.csv", show_col_types = FALSE)
nba_players <- read_csv("../datasets/nba/players.csv", show_col_types = FALSE)
```

Great, the two dataframes should appear in your environment in the upper right side in R studio. 


Let's take a quick look at these trend dataframe using str() function The str() function shows the number of rows (observations) and columns (variables). It also provides information on the name of each column, its type and an example of some of the values in each column.

```{r firstlook}
str(nba_players)
str(nba_salaries)
```

We see that most variables/ columns, already are in the type which we want. R automatically picked up on the format. Text variables are "chr" for "character"; Numeric variables are "num". It is very important that you understand the types of columns/ variables that R recognized. If you need a refresher, go here [hyperlink].

## Merge datasets

We see that "nba_salaries" contains the salaries of players for various seasons.
"players" contains many career statistics about players, for example, how many points they scored on average per game, across their whole career. 

Now we want to link both datasets. We can do this using the `merge()` function.
An alternative would be `join()`. 

```{r merge}
data_nba <- merge(nba_players, nba_salaries, by.x = c("_id"), by.y=c("player_id"))
rm(nba_players, nba_salaries)
```


## Clean dataset

We can use the select() function to kick out columns and the filter() function to kick out rows. First, we need to look at the codebook and the questionnaire to understand the what each variable refers to (see .txt file "data_description"). 

When using the select function, we will also rename the variables to make them more intuitive.

First, let's filter out Let's filter all years between 2012-2022. 

Afterwards, we use the save() function to store the data as a .Rdata file and the write_excel() function to store the reduced dataset. This way we can simply load that one next time and save time.

```{r select}
data_nba <- data_nba %>%
        select(everything(), -league, -highSchool) %>%
        filter(season_start>=1998)
save(data_nba, file ="../datasets/nba/data_nba.RData")

```


## change variables

Let's do some data cleaning. First, we want to calculate each players' age at the 
beginning of each season. Currently, we only have the date of birth and the year
for each season.

Second, we want recode the "position" variable. Some players played multiple
position, so that info is messy. We want to create varies dummy variables 
for each position. 


```{r recode}

# let's calculate age for every season
class(data_nba$birthDate) # nice, it is already a date variable

library(lubridate)
data_nba <- data_nba %>%
  mutate(year_of_birth = year(mdy(birthDate)),
         age = season_start - year_of_birth)


# let's clean the position

table(data_nba$position)

data_nba <- data_nba %>%
  mutate(
    position_center = 
      case_when(position = str_detect(position,"Center") ~ 1,
                TRUE ~ 0),
    position_sf = 
      case_when(position = str_detect(position,"Small Forward") ~ 1,
                TRUE ~ 0),
    position_pf = 
      case_when(position = str_detect(position,"Power Forward") ~ 1,
                TRUE ~ 0),
    position_sg = 
      case_when(position = str_detect(position,"Shooting Guard") ~ 1,
                TRUE ~ 0),
    position_pg = 
      case_when(position = str_detect(position,"Point Guard") ~ 1,
                TRUE ~ 0))



data_nba <- data_nba %>%
  select("_id", name, age, weight, height, birthPlace, everything(), -position, -birthDate, -year_of_birth)
save(data_nba, file ="../datasets/nba/data_nba.RData")
```

Now, we want to create a variable that gives us the number of seasons (i.e.years)
that each player played. Since the dataset is organized in seasons, each row 
is one season. Counting the rows per player gives us the years they played.


```{r change_vr_0}
data_nba <- data_nba %>%
  group_by("_id") %>%
  mutate(seasons_played = n()) %>%
  ungroup()

```


Almost done. When we browse the dataset, we recognize that the height and weight variables are stored as characters. Let's convert them to numeric, so we can
use them in operations. 

```{r change_vr_1}
str(data_nba$weight)
str(data_nba$height)

data_nba <- data_nba %>%
  mutate(weight = str_replace(weight, "lb", ""),
         weight = as.numeric(weight),
         height = str_replace(height, "-", "."),
         height = as.numeric(height))

str(data_nba)
```


## Explore the whole dataset

Now, let's explore some packages which help us to explore the dataframe as a whole.
Let's start with the `skimR` package: 

```{r}
#install.packages("skimr")
library("skimr")

skim(data_nba)
```

The `skim()` function provides a very handy overview of the whole dataset including the types of columns (i.e. variables), a summary of all variables, the extent of missing data etc. One advantage is that the output is "tidy" which means it is easy to work with further if needed. The output can be stored as dataframe, for example, which makes graphs much easier.

Next, another alternative is the `DataExplorer` package. It is nice to get a graphical overview of variables and the "missingness" of data. 

```{r explore_dt_0, warning=FALSE}
library(DataExplorer)

# overview of types of variables and missingness
introduce(data_nba)

# plots the info from above
plot_intro(data_nba)

#plots percentages missing across variables
plot_missing(data_nba)

# plots frequencies across variables
plot_bar(data_nba)
```

Now, let's try gtSummary for summary tables. A summary table is always a useful start once you have identified the type of variables you are interested in. 

Let's assume we are interested in age, seasons played, career points, salary,
position, and right or left handed (i.e. "shoots")

```{r explore_dt_1, warning=FALSE}
library(gtsummary)

data_nba %>% 
  select(age, seasons_played, shoots, career_PTS, salary, contains("position")) %>%
         tbl_summary(
           statistic = all_continuous() ~ c("{mean} ({min}, {max})")) 
         
```


Now, let's look at a correlation matrix between all numeric
variables in the dataset.

```{r explore_dt_2, warning=FALSE, message=FALSE}
library("corrr")
library("corrplot")

data_nba_numeric <- data_nba %>%
  select(where(is.numeric)) %>%
  na.omit()

# Find constant columns
constant_columns <- sapply(data_nba_numeric, function(x) length(unique(x)) == 1)

# Remove constant columns
data_nba_numeric <- data_nba_numeric[, !constant_columns]
# as number
corrmatrix <- data_nba_numeric %>%
  correlate() %>%    # Create correlation data frame (cor_df)
  rearrange() %>%  # rearrange by correlations
  shave() 

fashion(corrmatrix)

# as plot
rplot(corrmatrix)

# or...ggplot approach
library("ggcorrplot")

corrmatrix <- round(cor(data_nba_numeric), 1)

ggcorrplot(corrmatrix,
           method = "circle",
           type="lower")
```

This is interesting for a first look. For example, it seems that the weight is 
strongly correlated with whatever position you play. Centers are heavy, point
guards are light weights. 
We also see that most performance metrics ("career_...") are correlated with each
other and also with salary. Good players seem to be good in many things, and
good players seem to be paid more. 



## explore individual variables

Now, that we have a feeling for the whole dataset, we want to explore individual 
variables. To keep it focused, we want to further explore the question
of whether players that score more on average are also paid more. 

Maybe roles are clearly divided on the team. Maybe really good passers are highly
paid because they give great passes to people who then score. Or maybe teams
don't care about passers and just pay more to people who score more. 

So, now, let's look at salary and average number of points scored by game. 
Also, we want to know whether point guards (short people who pass a lot) are
paid less then other positions (who score more). 


First, let's look how the two continuous variables are distributed:

```{r explore_dt_3, warning=FALSE, message=FALSE}
data_nba %>% ggplot() + 
geom_boxplot(aes(y=salary)) +
  facet_wrap(~position_pg) +
  theme_light()

data_nba %>% ggplot() + 
geom_boxplot(aes(y=career_PTS)) + 
  theme_light()

data_nba %>% ggplot() + 
geom_boxplot(aes(y=career_PTS)) +
  facet_wrap(~position_pg) +
  theme_light()

```


Let's look at the relationship between salary and position as well as the 
relationship between position and points.


```{r explore_dt_4, warning=FALSE, message=FALSE}
str(data_nba$position_pg)
str(data_nba$salary)
str(data_nba$career_pts)


data_nba %>% 
  ggplot() +
  geom_bar(aes(x = position_pg, 
               y = salary),
           position = "dodge",
           stat = "summary",
           fun = "mean") + 
  #xlim(0, 10000000) +
  labs(title = "Average salary (Point guard vs other positions)",
       subtitle = "this is not that interesting",
       caption = "Authors' calculation; NBA data 1998-2018") +
  xlab("Player's position") +
  ylab("Player's salary") +
  theme_minimal()
  
## alternatively:

data_nba %>% 
  group_by(position_pg) %>%
  summarize(mean_salary = mean(salary, na.rm=T)) %>%
  ggplot() +
  geom_bar(aes(x = as.factor(position_pg), 
               y = mean_salary),
           stat = "identity") + 
  ylim(0, 6000000) +
  labs(title = "Average salary (Point guard vs other positions)",
       subtitle = "this is not that interesting",
       caption = "Authors' calculation; NBA data 1998-2018") +
  xlab("Player's position") +
  ylab("Player's salary (in million USD)") +
  theme_minimal()


# Now the relationship between position and points:

data_nba %>% 
  group_by(position_pg) %>%
  summarize(mean_points = mean(career_PTS, na.rm=T)) %>%
  ggplot() +
  geom_bar(aes(x = as.factor(position_pg), 
               y = mean_points),
           stat = "identity") + 
  ylim(0,15) +
  labs(title = "Average points per game (Point guard vs other positions)",
       subtitle = "this is not that interesting",
       caption = "Authors' calculation; NBA data 1998-2018") +
  xlab("Player's position") +
  ylab("Points per game") +
  theme_minimal()
  
```

So, it seems that point gards are paid a little less even though they make a few more points on average. Interesting puzzle to explore. 

```{r explore_dt_5, warning=FALSE, message=FALSE}

# find example for using histogramm()
# find example for first just creating cross tabs as perecntages tbl_cross(); summarize(); tabyl()

```

Now, let's explore the relationship which is at the heart of our analysis from now on: salary and average points. 

```{r explore_dt_6, warning=FALSE, message=FALSE}

# simple scatterplot
data_nba %>% ggplot() +
geom_point(aes(y=salary, x=career_PTS)) + 
  theme_minimal()

# Now, let's add a line
data_nba %>% 
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
       theme_minimal()

# let's look the relatiship separate for every year
data_nba %>% 
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
        facet_wrap(~season_start) + 
       theme_minimal()


# let's look the relatiship for separate teams
data_nba %>% 
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
        facet_wrap(~team) + 
       theme_minimal()

# let's look at it by position
scatter_pg <- data_nba %>% filter(position_pg ==1) %>%
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
       theme_minimal()

scatter_center <- data_nba %>% filter(position_center ==1) %>%
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
       theme_minimal()

scatter_pf <- data_nba %>% filter(position_pf ==1) %>%
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
       theme_minimal()

scatter_sf <- data_nba %>% filter(position_sf ==1) %>%
  ggplot(aes(y=salary, x=career_PTS)) +
    geom_point() + 
     stat_smooth(method = "lm") + 
       theme_minimal()

library("ggpubr")
ggarrange(scatter_center, scatter_pf,
          scatter_sf, scatter_pg,
          ncol = 2, nrow = 2,
          labels = c("Center",
                     "Power Forward",
                     "Small Forward",
                     "Point Guard"))


# yet a better way to compare this could be:

data_nba %>% 
  ggplot(aes(y=salary, x=career_PTS, color=as.factor(position_pg))) +
    geom_point() + 
     stat_smooth(method = "lm",
                 aes(group=as.factor(position_pg))) + 
       theme_minimal()

data_nba %>% 
  ggplot(aes(y=salary, x=career_PTS, color=as.factor(position_center))) +
    geom_point() + 
     stat_smooth(method = "lm",
                 aes(group=as.factor(position_center))) + 
       theme_minimal()


```

Let's reflect a moment what we can learn from all this. 

First, there seems to be a somewhat linear relationship between how many points 
a player scores and how much they are paid. This relationship seems pretty robust across years and teams. It also holds true for point guards just as much as for non-point guards. However, the average salary for point guards is lower in comparison. We also learn that the link between salary and points is stronger for centers. They seems to be paid more, the more they score. 

We have set the stage now for linear regression (next week). Linear regression
is all about further exploring the relationship between two variables, one outcome (often called "y") and one independent variable (often called "x"). Independent variables have many names. They are sometimes called "covariates"; "predictors"; "exposure", depending on the context. 

There are a number of cool things that regression can do for us that simple EDA cannot: 
 
1) It can model the relationship between two variables while considering simultaneously the potential influence of other factors. Image we are interested
in the effect of points per game on salary regardless of position, season or team.
With regression we can estimate how much more a player would ear every season
if he scored 10 more points a game (regardless of the position he plays).

2) It can assess what explains the effect of one variable on another (i.e. mediation). Maybe we find that point guards earn less and we want to know why. Is it because they score less? Is it because they play less time on average?

3) It can be used to predict salaries for players for whom we don't know the salary or even for hypothetical players. We could also look at the performance trend of players and predict whether they earn more next season or not.






